name: ğŸš€ Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup SSH
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.EC2_SSH_KEY }}
        known_hosts: ${{ secrets.EC2_HOST }}
        if_key_exists: replace
        
    - name: ğŸš€ Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} '
          cd ~/wisdom-video-app
          git pull origin main
          if git diff --name-only HEAD~1 HEAD | grep -E "(Dockerfile|docker-compose.yml|requirements.txt)"; then
            echo "ğŸ”„ Rebuilding Docker images..."
            docker-compose build --no-cache
          fi
          docker-compose up -d
          echo "âœ… Deployment completed!"
        '
        
    - name: ğŸ¥ Health Check
      run: |
        sleep 30
        curl -f http://${{ secrets.EC2_HOST }}:8501/_stcore/health || exit 1
        echo "âœ… Health check passed!" 