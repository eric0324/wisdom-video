name: ğŸš€ Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup SSH
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.EC2_SSH_KEY }}
        known_hosts: unnecessary
        if_key_exists: replace
        
    - name: ğŸ” Debug SSH Setup
      run: |
        echo "ğŸ” Checking SSH key setup..."
        ls -la ~/.ssh/
        ssh-keygen -lf ~/.ssh/id_rsa || echo "âŒ SSH key validation failed"
        
    - name: ğŸš€ Deploy to EC2
      run: |
        echo "ğŸš€ Starting deployment to EC2..."
        ssh -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${{ secrets.EC2_HOST }} '
          echo "âœ… SSH connection successful!"
          
          echo "ğŸ” Checking possible directories..."
          echo "Home directory contents:"
          ls -la ~/
          echo "Root directory contents:"
          ls -la /
          
          # æª¢æŸ¥å¯èƒ½çš„è·¯å¾‘
          if [ -d "~/wisdom-video-app" ]; then
            PROJECT_DIR="~/wisdom-video-app"
          elif [ -d "~/wisdom-video" ]; then
            PROJECT_DIR="~/wisdom-video"
          elif [ -d "/wisdom-video-app" ]; then
            PROJECT_DIR="/wisdom-video-app"
          elif [ -d "/wisdom-video" ]; then
            PROJECT_DIR="/wisdom-video"
          else
            echo "âŒ Project directory not found in common locations"
            echo "Available directories in home:"
            find ~ -maxdepth 2 -type d -name "*wisdom*" || echo "No wisdom directories found"
            exit 1
          fi
          
          echo "ğŸ“ Using project directory: $PROJECT_DIR"
          cd "$PROJECT_DIR" || { echo "âŒ Cannot access directory: $PROJECT_DIR"; exit 1; }
          echo "ğŸ“ Current directory: $(pwd)"
          
          echo "ğŸ”„ Pulling latest changes..."
          git pull origin main || { echo "âŒ Git pull failed"; exit 1; }
          
          if git diff --name-only HEAD~1 HEAD | grep -E "(Dockerfile|docker-compose.yml|requirements.txt)"; then
            echo "ğŸ”„ Rebuilding Docker images..."
            docker-compose build --no-cache || { echo "âŒ Docker build failed"; exit 1; }
          else
            echo "â„¹ï¸  No rebuild needed"
          fi
          
          echo "ğŸ³ Starting services..."
          docker-compose up -d || { echo "âŒ Docker compose up failed"; exit 1; }
          echo "âœ… Deployment completed!"
        '
        
    - name: ğŸ¥ Health Check
      run: |
        echo "â³ Waiting for services to start..."
        sleep 30
        echo "ğŸ¥ Performing health check..."
        if curl -f http://${{ secrets.EC2_HOST }}:8501/_stcore/health; then
          echo "âœ… Health check passed!"
        else
          echo "âŒ Health check failed!"
          exit 1
        fi 